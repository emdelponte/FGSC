---
title: ""
author: ""
date: ""
output:
  html_document:
    theme: flatly
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
    code_folding: hide
    css: style.css
---


```{r setup, include=FALSE}

library(here)
library(readxl)
library(tidyverse)
library(crosstalk)
library(plotly)
library(viridis)
library(gsheet)
theme_set(theme_grey())
Sys.setlocale("LC_ALL", 'pt_BR.UTF-8')

```

```{r load data, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# carrega os dados com lat e long
s1 <- read_excel(here("data", "fgsc-dat4.xlsx"), 1)
s2 <- read_excel(here("data", "fgsc-dat4.xlsx"), 2)
s3 <- read_excel(here("data", "fgsc-dat4.xlsx"), 3)
s4 <- read_excel(here("data", "fgsc-dat4.xlsx"), 4)
s5 <- read_excel(here("data", "fgsc-dat4.xlsx"), 5)
s6 <- read_excel(here("data", "fgsc-dat4.xlsx"), 6)
s7 <- read_excel(here("data", "fgsc-dat4.xlsx"), 7)
s8 <- read_excel(here("data", "fgsc-dat4.xlsx"), 8)
s9 <- read_excel(here("data", "fgsc-dat4.xlsx"), 9)
s10 <- read_excel(here("data", "fgsc-dat4.xlsx"), 10)
s11 <- read_excel(here("data", "fgsc-dat4.xlsx"), 11)
s12 <- read_excel(here("data", "fgsc-dat4.xlsx"), 12)
s13 <- read_excel(here("data", "fgsc-dat4.xlsx"), 13)
s14 <- read_excel(here("data", "fgsc-dat4.xlsx"), 14)
s15 <- read_excel(here("data", "fgsc-dat4.xlsx"), 15)
s16 <- read_excel(here("data", "fgsc-dat4.xlsx"), 16)
s19 <- read_excel(here("data", "fgsc-dat4.xlsx"), 19)
s20 <- read_excel(here("data", "fgsc-dat4.xlsx"), 20)
s21 <- read_excel(here("data", "fgsc-dat4.xlsx"), 21)
s22 <- read_excel(here("data", "fgsc-dat4.xlsx"), 22)
s23 <- read_excel(here("data", "fgsc-dat4.xlsx"), 23)
s24 <- read_excel(here("data", "fgsc-dat4.xlsx"), 24)
s25 <- read_excel(here("data", "fgsc-dat4.xlsx"), 25)
s26 <- read_excel(here("data", "fgsc-dat4.xlsx"), 26)
s27 <- read_excel(here("data", "fgsc-dat4.xlsx"), 27)
s28 <- read_excel(here("data", "fgsc-dat4.xlsx"), 28)
s29 <- read_excel(here("data", "fgsc-dat4.xlsx"), 29)
s30 <- read_excel(here("data", "fgsc-dat4.xlsx"), 30)
s31 <- read_excel(here("data", "fgsc-dat4.xlsx"), 31)
s32 <- read_excel(here("data", "fgsc-dat4.xlsx"), 32)
s33 <- read_excel(here("data", "fgsc-dat4.xlsx"), 33)
s34 <- read_excel(here("data", "fgsc-dat4.xlsx"), 34)
s35 <- read_excel(here("data", "fgsc-dat4.xlsx"), 35)
s36 <- read_excel(here("data", "fgsc-dat4.xlsx"), 36)
s37 <- read_excel(here("data", "fgsc-dat4.xlsx"), 37)
s38 <- read_excel(here("data", "fgsc-dat4.xlsx"), 38)
s39 <- read_excel(here("data", "fgsc-dat4.xlsx"), 39)
fgsc2 <- rbind(s1, s2, s3, s4, s5, s6, s7, s8, s9, s10, s11, s12, s13, s14, s15, s16, s19, s20, s21, s22, s23, s24, s25, s26, s27, s28, s29, s30, s31, s32, s33, s34, s35, s36, s37, s38, s39)
fgsc2$Latitude <- round(jitter(fgsc2$Latitude, factor = 6),4)
fgsc2$Longitude <- round(jitter(fgsc2$Longitude, factor = 6),4)
fgsc <- fgsc2 %>% select(c(13,2,6,7, 8,9, 10, 14, 19, 20, 21))
library(plyr)
table(fgsc$FGSC)
fgsc$FGSC2 <- revalue(fgsc$FGSC,  c("F. graminearum" = "Fgra", "F. meridionale" = "Fmer", "F. cortaderiae" = "Fcor", "F. austroamericanum" = "Faus","F. asiaticum" = "Fasi", "F. louisianense" = "Flou", "F. boothii" = "Fboo", "F. gerlachii" = "Fger", "F. ussurianum" = "Fuss","F. vorosii" = "Fvor", "F. acaciae-mearnsii" = "Faca", "F. boothii X F. graminearum" = "Fboo x Fgra", "F. brasilicum" = "Fbra","F. aethiopicum" = "Faet"))
fgsc$Year <- as.numeric(fgsc$Year)
fgsc <- fgsc %>%  filter(FGSC != 30) %>%  filter(FGSC != "F. cerealis") %>% filter(FGSC != "F. culmorum") 
fgsc$Host <- revalue(fgsc$Host, 
                     c("oat" = "Oat",  "corn" = "Maize","wheat" = "Wheat", "barley" = "Barley"))
fgsc$Tri_genotype <- revalue(fgsc$Tri_genotype, c("NX2" = "NX-2"))
write.csv(fgsc, here("data", "data-fgsc.csv"))

```


```{r include=FALSE}
# load the article database
#library(gsheet)
#articles <-
# gsheet2tbl('https://docs.google.com/spreadsheets/d/1rAC_U5upuDPHCSLi9kieb4R5tztHVJGW84aQOf6z7Lk/edit?usp=sharing') 
#articles <- articles 
articles <- read_csv(here("data", "articles-reviewed.csv"))

```

# Bibliographic analysis

Bibliographic data were obtained from peer-reviewed articles (n = `r nrow(articles)`) which were indexed as a bibliographic source for the information on the FGSC isolates in our database. The indexed articles were published from `r min(articles$year)` to `r max(articles$year)`. Follows a summary for these data.

## Articles per year

```{r include=FALSE}
year <- articles %>% 
  select(year) %>% 
  group_by(year) %>% 
  tally(sort = T) 
```

The number of articles published per year ranged from `r min(year$n)` to `r max(year$n)`. The year with most number of articles was `r year[1,1]`

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
articles %>% 
  ggplot(aes(year))+
  geom_bar(aes(fill = factor(pub_order)))+
  scale_y_continuous(breaks=seq(0, 11, 1), expand=c(0.02, 0))+
  scale_x_continuous(breaks=seq(2000, 2017))+
  labs(y = "Number of articles", x = "Published year", title = "Articles per year")
  
```


## Journals

```{r include=FALSE}
journal <- articles %>% 
  select(journal_name) %>% 
  group_by(journal_name) %>% 
  tally(sort = T) 
```

The articles were published in `r nrow(journal)` scientific journals. The journal with most number of publications was `r journal[1,1]` with `r max(journal$n)` articles, followed by `r journal[2,1]` (`r journal[2,2]` articles) and `r journal[3,1]` (`r journal[3,2]` articles).


```{r message=FALSE, warning=FALSE, paged.print=TRUE}
articles %>% 
  ggplot(aes(reorder(journal_name, journal_name, function(x) length(x))))+
  geom_bar(aes(fill = factor(pub_order)))+
  scale_y_continuous(breaks=seq(0,10), expand=c(0.01, 0))+
  coord_flip()+
  labs(y = "Number of articles", x = "", title = "Articles per journal")
```



```{r eval=FALSE, include=FALSE}
library(rcrossref)
articles %>% 
  group_by(article_ID, DOI) %>% 
  do(cr_citation_count(doi = DOI))
#for (i in articles$DOI){
#  print(cr_citation_count(doi = i))
#}
```



## Authorship 

### Country affiliations


```{r include=FALSE}
countries <- articles %>% 
  gather(code, country, 25:30) %>% 
  filter(country != "NA") %>%
  select(country) %>% 
  group_by(country) %>% 
  tally(sort = T) 
```


For each article, the countries reported in the affiliations of the authors were indexed. We recorded the country name only once per article regardless of the number of authors from a same country. There were `r nrow(countries)` unique countries, and the three most unique occurrences were `r countries[1,1]`, `r countries[2,1]` and `r countries[3,1]`.  

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
articles %>% 
  gather(code, country, 25:30) %>% 
  filter(country != "NA") %>% 
  ggplot(aes(reorder(country, country, function(x) length(x))))+
  geom_bar(aes(fill = factor(pub_order)))+
  scale_y_continuous(breaks=seq(0,30,2), expand=c(0.01, 0))+
  coord_flip()+
  labs(y = "Number of articles", x = "", title = "Articles per country" )
```



### Number of authors


```{r message=FALSE, warning=FALSE, paged.print=TRUE}
authors <- articles %>% 
  gather(author, name, 6:19) %>% 
  select(author, name) %>% 
  filter(name != "NA") %>% 
  group_by(name) %>% 
  tally(sort = T) 
```

There were `r nrow(authors)` unique authors in the collection of `r nrow(articles)` indexed articles. Let's see the list of 20 most prolific authors and a frequency plot for authors who have published at least three articles.



```{r}
head(authors, 20)
```



```{r}
authors %>% 
  filter(n > 2) %>% 
  ggplot(aes(reorder(name, n), n))+
  geom_col()+
  scale_y_continuous(breaks=seq(0,30,3),  expand=c(0.01, 0))+
  coord_flip()+
  labs(x = "", y = "Frequency", title ="Articles per author")
```

### Wordcloud 

A wordcloud is an alternative way to visualize the frequency of articles for all authors. The size of the name is relative to the number of articles.

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(wordcloud)
#png("FGSC-authors.png", width=12, height=12, units="in", res=300)
wordcloud(authors$name, authors$n, c(4,.5), 1, random.order = F, colors=brewer.pal(8, "Dark2"))
#dev.off()

```


## Scholarly collaborative network 

A network analysis was conducted to identify the connections among the authors and the scientific communities. For such, we need to build an edge list, or all pairs of occurrences of two authors in a same publication. Let's see below the first 10 pairs or authors. The whole list has almost one thousand pairs.


```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(purrr)
library(purrrlyr)

authors_net <- articles %>% select (6:19)
author_list <- flatten(by_row(authors_net, ..f = function(x) flatten_chr(x), .labels = FALSE))
author_list <- lapply(author_list, function(x) x[!is.na(x)])

# create the edge list
author_edge_list <- t(do.call(cbind, lapply(author_list[sapply(author_list, length) >= 2], combn, 2)))

author_edge_list[1:10, ]

```

Within an authorship network, co-authors (same article) are linked together. Authors from this group can be connected to authors in another publication whenever they are co-authors in another article. Therefore, two articles can be linked by a common author. Each author is then considered a **node** in the network and the connections between them are the **edges**. There are several statistics to calculate in a network analysis. 

For now, let's visualize the authorship network and the community structure which was defined via a function that tries to find densely connected subgraphs, also called communities, via random walk algorithm. The idea is that short random walks tend to stay in the same community. In the network below, there are 15 communities or subgraphs which are represented by distinct colors.


```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# igraph
library(igraph)
net=graph.edgelist(as.matrix(author_edge_list), directed=FALSE)
degree <- data.frame(degree(net))
#summary(degree$degree.net.)
between <- data.frame(round(betweenness(net), 1))
page <- data.frame(page_rank(net)$vector)
close <-data.frame(round(closeness(net), 10))
eigen <- data.frame(round(evcent(net)$vector, 5))
```

### Network graph

```{r cache=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(network)
library(intergraph)

# Clusters
wc <- cluster_walktrap(net)
# Modularity
mod <- modularity(wc)
ms <- membership(wc)

net_stat <- asNetwork(net)
#png("network1.png", res = 600,  width = 4000 , height = 4000, units="px")
set.seed(1003)
par(mar=c(0,0,0,0))
plot.network(net_stat, vertex.cex= 0.05 + 0.25*log(graph.strength(net)), label =ifelse(degree(net)>24,V(net)$name,NA), label.bg = "NA", label.col = "black", edge.col = "lightgray", edge.lty = 0.5, label.cex = 0.7,  displaylabels = TRUE, vertex.col = membership(wc), jitter = T, edge.len = 0.2, boxed.labels=T, label.border="NA", pad=1.2)
#dev.off()
```


### Interactive network graph

An interactive graph allows to navigate and visualize the connection among the authors. We use a function of the `networkD3` package to build the plot. 

[Open the network in another page](network-FGSC.html)   


```{r message=FALSE,  warning=FALSE, include=FALSE, paged.print=FALSE}
get.edgelist(net)
edge_df <- as.data.frame(get.edgelist(net))
colnames(edge_df) <- c("from", "to")
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(networkD3)
netD3 <- simpleNetwork(edge_df, zoom = T,
              fontFamily = "Arial",
              fontSize = 13,
              charge = -200,
              linkColour = "lightgrey",
              linkDistance = 80,
              nodeColour = "black",
              opacity = 1
              
             )
netD3
 saveNetwork(netD3, file = 'network-FGSC.html')
```


### Statistics

There are several statistics to compute at the network, node and edge level. 

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(broom)

# Transitivity
trans <- transitivity(net, type = "global")

# Degree 
deg <- degree(net)
deg <- tidy(deg) 
deg2 <- deg %>% group_by(names) %>% 
  arrange(desc(x)) %>% head(20)

# Betweenness
bet <- betweenness(net, normalized = TRUE, directed = FALSE)
bet <- tidy(bet) 
bet2 <- bet %>% group_by(names) %>% 
  arrange(desc(x)) %>%  head(20)


# Eigenvector centrality
eigen <- eigen_centrality(net)
eigen1 <- tidy(eigen$vector) 
eigen2 <- eigen1 %>% group_by(names) %>% 
  arrange(desc(x)) %>%  head(20)


# Page rank centrality
rank <- page.rank(net)
rank1 <- tidy(rank$vector) 
rank2 <- rank1 %>% group_by(names) %>% 
  arrange(desc(x)) %>%  head(20)

# Closeness centrality
close <- closeness(net)
close1 <- tidy(close) 
close2 <- close1 %>% group_by(names) %>% 
  arrange(desc(x)) %>%  head(20)

# Clusters
wc <- cluster_walktrap(net)


# Modularity
mod <- modularity(wc)
ms <- membership(wc)

# clustering edge betweenness
eb <- cluster_edge_betweenness(net)
```


#### Network transitivity

Transitivity, also know as clustering coefficient, is the mean probability that two author with a common author are themselves co-authors. In our study the transivity was **`r trans`**, meaning that, on average, the chance that two scholars that share a common collaborator wrote a paper together is almost 50%.

#### Node degree

Individually, authors can be highly connected or influential. The degree of a node is a basic structural property that quantify the number of adjacents nodes or edges. Let's see the 25 authors with most degree.

```{r}
deg2
```

#### Betweenness

Betweenness is a centrality measure based on the shortest paths. The betweenness centrality for each vertex is the number of these shortest paths that pass through the vertex. It represents the degree of which nodes stand between each other.

```{r}
bet2
```

#### Page rank

This is the  Google PageRank for the specified vertices.
```{r}
rank2
```

#### Eigenvector

Thi is a measure of the influence of a node (author) in a network. It assigns relative scores to all nodes in the network based on the concept that connections to high-scoring nodes contribute more to the score of the node in question than equal connections to low-scoring nodes.


```{r}
eigen2
```

#### Closeness

Cloness centrality measures how many steps is required to access every other vertex from a given vertex.



```{r}
close2
```


